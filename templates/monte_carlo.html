{% extends "base.html" %}

{% block title %}Monte Carlo Simulation - Bowen Yao{% endblock %}

{% block content %}
<!-- Hero Section (Same style as Pricing page) -->
<div class="hero-section" style="min-height: 60vh;">
    <div class="hero-background"></div>
    <div class="hero-content">
        <div class="container text-center">
            <div class="hero-text">
                <h1 class="hero-title" style="font-size: 2.5rem;">
                    <span class="gradient-text">Monte Carlo</span>
                    <span class="gradient-text-alt">Simulation</span>
                </h1>
                <p class="hero-subtitle">STOCHASTIC PATH GENERATION</p>
                <p class="hero-description">
                    Advanced option pricing through simulation<br>
                    with multiple stochastic models and path analysis.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container main-content">
    <div class="row g-4">
        <!-- Control Panel -->
        <div class="col-lg-4">
            <div class="calculator-card">
                <h5 class="section-title mb-4" style="font-size: 1.5rem;">Simulation Setup</h5>
                
                <form id="monteCarloForm">
                    <div class="input-group-modern">
                        <label for="mcSpot" class="form-label-modern">Spot Price</label>
                        <input type="number" class="form-control-modern" id="mcSpot" value="100" step="0.01" min="0.01">
                        <span class="input-suffix">$</span>
                    </div>

                    <div class="input-group-modern">
                        <label for="mcStrike" class="form-label-modern">Strike Price</label>
                        <input type="number" class="form-control-modern" id="mcStrike" value="100" step="0.01" min="0.01">
                        <span class="input-suffix">$</span>
                    </div>

                    <div class="input-group-modern">
                        <label for="mcTime" class="form-label-modern">Time to Expiry</label>
                        <input type="number" class="form-control-modern" id="mcTime" value="1" step="0.01" min="0.01">
                        <span class="input-suffix">years</span>
                    </div>

                    <div class="input-group-modern">
                        <label for="mcRate" class="form-label-modern">Risk-free Rate</label>
                        <input type="number" class="form-control-modern" id="mcRate" value="5" step="0.1" min="0">
                        <span class="input-suffix">%</span>
                    </div>

                    <div class="input-group-modern">
                        <label for="mcVol" class="form-label-modern">Volatility</label>
                        <input type="number" class="form-control-modern" id="mcVol" value="20" step="0.1" min="0.1">
                        <span class="input-suffix">%</span>
                    </div>

                    <div class="input-group-modern">
                        <label for="mcPaths" class="form-label-modern">Number of Paths</label>
                        <input type="number" class="form-control-modern" id="mcPaths" value="10000" step="1000" min="100">
                        <span class="input-suffix">paths</span>
                    </div>

                    <div class="input-group-modern">
                        <label for="mcModel" class="form-label-modern">Model Type</label>
                        <select class="form-control-modern" id="mcModel">
                            <option value="gbm">Geometric Brownian Motion</option>
                            <option value="heston">Heston Model</option>
                            <option value="jump">Jump Diffusion</option>
                        </select>
                    </div>

                    <div class="d-grid gap-3 mt-4">
                        <button type="submit" class="btn-modern btn-calculate">
                            <i class="fas fa-play me-2"></i>Run Simulation
                        </button>
                        <button type="button" class="btn-modern btn-tertiary-modern" onclick="resetMCForm()">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </form>
            </div>

            <!-- Simulation Statistics -->
            <div class="calculator-card mt-4">
                <h5 class="section-title mb-4" style="font-size: 1.5rem;">Statistics</h5>
                <div id="mcStatistics">
                    <div class="results-placeholder">
                        <i class="fas fa-chart-bar results-icon"></i>
                        <p>Run simulation to see statistics</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-lg-8">
            <!-- Price Paths Visualization -->
            <div class="results-card-modern mb-4">
                <h5 class="results-title">Price Paths</h5>
                <div id="pathsChart" style="height: 400px;">
                    <div class="results-placeholder" style="padding-top: 150px;">
                        <i class="fas fa-chart-line results-icon"></i>
                        <h6>Path Simulation</h6>
                        <p>Configure parameters and run simulation to see price paths.</p>
                    </div>
                </div>
            </div>

            <!-- Distribution Analysis -->
            <div class="results-card-modern mb-4">
                <h5 class="results-title">Terminal Price Distribution</h5>
                <div id="distributionChart" style="height: 350px;">
                    <div class="results-placeholder" style="padding-top: 120px;">
                        <i class="fas fa-chart-bar results-icon"></i>
                        <h6>Distribution Analysis</h6>
                        <p>Terminal price distribution will appear here after simulation.</p>
                    </div>
                </div>
            </div>

            <!-- Convergence Analysis -->
            <div class="results-card-modern">
                <h5 class="results-title">Convergence Analysis</h5>
                <div id="convergenceChart" style="height: 300px;">
                    <div class="results-placeholder" style="padding-top: 100px;">
                        <i class="fas fa-compress-arrows-alt results-icon"></i>
                        <h6>Price Convergence</h6>
                        <p>Option price convergence analysis will be displayed here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Monte Carlo Simulation
document.getElementById('monteCarloForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const params = {
        spot: parseFloat(document.getElementById('mcSpot').value),
        strike: parseFloat(document.getElementById('mcStrike').value),
        time: parseFloat(document.getElementById('mcTime').value),
        rate: parseFloat(document.getElementById('mcRate').value) / 100,
        volatility: parseFloat(document.getElementById('mcVol').value) / 100,
        paths: parseInt(document.getElementById('mcPaths').value),
        model: document.getElementById('mcModel').value
    };
    
    // Simulate paths
    const paths = generatePaths(params);
    const terminalPrices = paths.map(path => path[path.length - 1]);
    const callPayoffs = terminalPrices.map(price => Math.max(price - params.strike, 0));
    const putPayoffs = terminalPrices.map(price => Math.max(params.strike - price, 0));
    
    // Calculate statistics
    const callPrice = callPayoffs.reduce((a, b) => a + b, 0) / callPayoffs.length * Math.exp(-params.rate * params.time);
    const putPrice = putPayoffs.reduce((a, b) => a + b, 0) / putPayoffs.length * Math.exp(-params.rate * params.time);
    
    // Display statistics
    displayStatistics(callPrice, putPrice, terminalPrices);
    
    // Plot charts
    plotPaths(paths, params);
    plotDistribution(terminalPrices);
    plotConvergence(callPayoffs, params);
});

// Generate price paths
function generatePaths(params) {
    const paths = [];
    const steps = 252; // Daily steps
    const dt = params.time / steps;
    
    for (let i = 0; i < Math.min(params.paths, 100); i++) { // Display max 100 paths
        const path = [params.spot];
        for (let j = 1; j <= steps; j++) {
            const dW = Math.sqrt(dt) * normalRandom();
            const drift = (params.rate - 0.5 * params.volatility * params.volatility) * dt;
            const diffusion = params.volatility * dW;
            const newPrice = path[j-1] * Math.exp(drift + diffusion);
            path.push(newPrice);
        }
        paths.push(path);
    }
    
    return paths;
}

// Display statistics
function displayStatistics(callPrice, putPrice, prices) {
    const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
    const std = Math.sqrt(prices.reduce((sum, price) => sum + Math.pow(price - mean, 2), 0) / prices.length);
    
    document.getElementById('mcStatistics').innerHTML = `
        <div class="mc-stats-grid">
            <div class="stat-item">
                <div class="stat-label">Call Price</div>
                <div class="stat-value">$${callPrice.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Put Price</div>
                <div class="stat-value">$${putPrice.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Mean Price</div>
                <div class="stat-value">$${mean.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Std Dev</div>
                <div class="stat-value">$${std.toFixed(2)}</div>
            </div>
        </div>
    `;
}

// Plot price paths
function plotPaths(paths, params) {
    const traces = paths.slice(0, 50).map((path, i) => ({
        x: Array.from({length: path.length}, (_, i) => i * params.time / (path.length - 1)),
        y: path,
        type: 'scatter',
        mode: 'lines',
        line: {
            color: `rgba(100, 200, 255, ${0.1 + Math.random() * 0.2})`,
            width: 1
        },
        showlegend: false
    }));
    
    // Add strike line
    traces.push({
        x: [0, params.time],
        y: [params.strike, params.strike],
        type: 'scatter',
        mode: 'lines',
        name: 'Strike',
        line: {
            color: '#ff6b6b',
            width: 2,
            dash: 'dash'
        }
    });
    
    const layout = {
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: '#e0e0e0' },
        xaxis: {
            title: 'Time (Years)',
            gridcolor: 'rgba(255, 255, 255, 0.1)',
            titlefont: { color: '#e0e0e0' },
            tickfont: { color: '#999' }
        },
        yaxis: {
            title: 'Price ($)',
            gridcolor: 'rgba(255, 255, 255, 0.1)',
            titlefont: { color: '#e0e0e0' },
            tickfont: { color: '#999' }
        },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: 'transparent'
        },
        margin: { t: 20, r: 20, b: 50, l: 50 }
    };
    
    Plotly.newPlot('pathsChart', traces, layout, {responsive: true, displayModeBar: false});
}

// Plot distribution
function plotDistribution(prices) {
    const trace = {
        x: prices,
        type: 'histogram',
        nbinsx: 30,
        marker: {
            color: 'rgba(100, 200, 255, 0.7)',
            line: {
                color: '#64c8ff',
                width: 1
            }
        }
    };
    
    const layout = {
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: '#e0e0e0' },
        xaxis: {
            title: 'Terminal Price ($)',
            gridcolor: 'rgba(255, 255, 255, 0.1)',
            titlefont: { color: '#e0e0e0' },
            tickfont: { color: '#999' }
        },
        yaxis: {
            title: 'Frequency',
            gridcolor: 'rgba(255, 255, 255, 0.1)',
            titlefont: { color: '#e0e0e0' },
            tickfont: { color: '#999' }
        },
        margin: { t: 20, r: 20, b: 50, l: 50 }
    };
    
    Plotly.newPlot('distributionChart', [trace], layout, {responsive: true, displayModeBar: false});
}

// Plot convergence
function plotConvergence(payoffs, params) {
    const convergence = [];
    let sum = 0;
    
    for (let i = 0; i < payoffs.length; i++) {
        sum += payoffs[i];
        convergence.push(sum / (i + 1) * Math.exp(-params.rate * params.time));
    }
    
    const trace = {
        x: Array.from({length: convergence.length}, (_, i) => i + 1),
        y: convergence,
        type: 'scatter',
        mode: 'lines',
        line: {
            color: '#64c8ff',
            width: 2
        }
    };
    
    const layout = {
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: '#e0e0e0' },
        xaxis: {
            title: 'Number of Paths',
            gridcolor: 'rgba(255, 255, 255, 0.1)',
            titlefont: { color: '#e0e0e0' },
            tickfont: { color: '#999' }
        },
        yaxis: {
            title: 'Option Price ($)',
            gridcolor: 'rgba(255, 255, 255, 0.1)',
            titlefont: { color: '#e0e0e0' },
            tickfont: { color: '#999' }
        },
        margin: { t: 20, r: 20, b: 50, l: 50 }
    };
    
    Plotly.newPlot('convergenceChart', [trace], layout, {responsive: true, displayModeBar: false});
}

// Normal random number generator
function normalRandom() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

// Reset form
function resetMCForm() {
    document.getElementById('mcSpot').value = '100';
    document.getElementById('mcStrike').value = '100';
    document.getElementById('mcTime').value = '1';
    document.getElementById('mcRate').value = '5';
    document.getElementById('mcVol').value = '20';
    document.getElementById('mcPaths').value = '10000';
    document.getElementById('mcModel').value = 'gbm';
    
    // Reset charts
    document.getElementById('pathsChart').innerHTML = `
        <div class="results-placeholder" style="padding-top: 150px;">
            <i class="fas fa-chart-line results-icon"></i>
            <h6>Path Simulation</h6>
            <p>Configure parameters and run simulation to see price paths.</p>
        </div>
    `;
    
    document.getElementById('distributionChart').innerHTML = `
        <div class="results-placeholder" style="padding-top: 120px;">
            <i class="fas fa-chart-bar results-icon"></i>
            <h6>Distribution Analysis</h6>
            <p>Terminal price distribution will appear here after simulation.</p>
        </div>
    `;
    
    document.getElementById('convergenceChart').innerHTML = `
        <div class="results-placeholder" style="padding-top: 100px;">
            <i class="fas fa-compress-arrows-alt results-icon"></i>
            <h6>Price Convergence</h6>
            <p>Option price convergence analysis will be displayed here.</p>
        </div>
    `;
    
    document.getElementById('mcStatistics').innerHTML = `
        <div class="results-placeholder">
            <i class="fas fa-chart-bar results-icon"></i>
            <p>Run simulation to see statistics</p>
        </div>
    `;
}
</script>

<style>
/* Monte Carlo specific styles matching Pricing page */
.mc-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.stat-item {
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 10px;
    text-align: center;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.stat-value {
    color: var(--primary);
    font-size: 1.25rem;
    font-weight: 600;
}
</style>
{% endblock %}